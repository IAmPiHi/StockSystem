<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銷售報表中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #fffdf0; font-family: 'Segoe UI', Roboto, sans-serif; color: #4a4a4a; min-height: 100vh; display: flex; flex-direction: column; }
        .navbar-custom { background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.08); padding: 15px 0; }
        .navbar-brand { font-weight: 800; font-size: 1.4rem; color: #333 !important; letter-spacing: 1px; }
        .nav-btn { position: relative; padding: 8px 20px; margin-left: 8px; border-radius: 50px; font-weight: 600; text-decoration: none; color: #666; transition: all 0.3s ease; display: flex; align-items: center; }
        .nav-btn:not(.logout-btn):hover, .nav-btn.active { background-color: #fff8e1; color: #d4a017; transform: translateY(-2px); }
        .logout-btn { color: #ff6b6b; border: 2px solid transparent; background-color: #fff5f5; }
        .logout-btn:hover { background-color: #ff6b6b; color: white !important; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); transform: translateY(-2px); }
        
        .content-card { background: #ffffff; border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.03); padding: 30px; margin-bottom: 30px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .section-title { color: #3d3d3d; font-weight: 700; margin-bottom: 0; border-left: 5px solid #ffda6a; padding-left: 15px; }
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        .table-custom thead th { background-color: #fff3cd; color: #664d03; border: none; padding: 15px; position: sticky; top: 0; z-index: 10; }
        .profit-positive { color: #198754; font-weight: 700; }
        .btn-yellow { background-color: #ffda6a; border: none; color: #3d3d3d; font-weight: 600; transition: 0.3s; }
        .btn-yellow:hover { background-color: #ffd13d; transform: translateY(-2px); }
        .scroll-area { max-height: 400px; overflow-y: auto; padding-right: 5px; }
        .footer-custom { background-color: #fff; border-top: 1px solid #eee; padding: 25px 0; margin-top: auto; color: #888; font-size: 0.9rem; }
        .footer-custom i { color: #ffda6a; }
        .scroll-area::-webkit-scrollbar { width: 8px; }
        .scroll-area::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-custom sticky-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-boxes-stacked me-2 text-warning" style="font-size: 1.6rem;"></i>
                庫存系統
            </a>
            <div class="d-flex align-items-center">
                <a class="nav-btn {% if request.path == '/' %}active{% endif %}" href="/">
                    <i class="fas fa-chart-line me-2"></i>儀表板
                </a>
                <a class="nav-btn {% if request.path == '/reports' %}active{% endif %}" href="/reports">
                    <i class="fas fa-file-invoice me-2"></i>報表
                </a>
                <div style="width: 1px; height: 25px; background: #eee; margin: 0 15px;"></div> 
                <a class="nav-btn logout-btn" href="/logout">
                    <i class="fas fa-sign-out-alt me-2"></i>登出
                </a>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
                {{ messages[0] }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
        {% endwith %}

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="fw-bold text-dark mb-0">數據概覽</h2>
            <a href="/manual_export" class="btn btn-yellow px-4 py-2 rounded-pill">
                <i class="fas fa-file-export me-2"></i>立即輸出今日總結
            </a>
        </div>

        <div class="content-card">
            <div class="section-header">
                <h4 class="section-title">趨勢分析</h4>
                <div class="d-flex align-items-center">
                    <label class="me-2 text-muted fw-bold small">檢視指標:</label>
                    <select id="trendMetricSelect" class="form-select form-select-sm" style="width: 200px; border-color: #ffda6a;" onchange="updateTrendCharts()">
                        <option value="profit" selected>淨利潤 (Profit)</option>
                        <option value="revenue">總營收 (Revenue)</option>
                        <option value="qty">售出數量 (Quantity)</option>
                    </select>
                </div>
            </div>
            <div class="row g-4">
                <div class="col-lg-6">
                    <h6 class="text-center text-muted mb-3">近 7 日走勢</h6>
                    <div class="chart-container">
                        <canvas id="dailyChart"></canvas>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h6 class="text-center text-muted mb-3">每月統計走勢</h6>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card">
            <div class="section-header">
                <h4 class="section-title">本月商品販售情況 (每月1號重置)</h4>
                <div class="d-flex align-items-center">
                    <label class="me-2 text-muted fw-bold small">檢視指標:</label>
                    <select id="pieMetricSelect" class="form-select form-select-sm" style="width: 200px; border-color: #ffda6a;" onchange="updatePieChart()">
                        <option value="profit" selected>淨利潤佔比</option>
                        <option value="revenue">總營收佔比</option>
                        <option value="qty">銷量佔比</option>
                    </select>
                </div>
            </div>
            <div class="row justify-content-center">
                <div class="col-lg-8 col-md-10">
                    <div class="chart-container" style="height: 400px;">
                        <canvas id="productPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="content-card h-100 p-0 overflow-hidden"> 
                     <div class="p-4 pb-0">
                        <h4 class="section-title">近期銷售紀錄 (48小時內)</h4>
                     </div>
                     <div class="table-responsive scroll-area px-4 pb-4 mt-3">
                        <table class="table table-custom table-hover align-middle mb-0">
                            <thead>
                                <tr>
                                    <th>時間</th>
                                    <th>商品</th>
                                    <th class="text-center">數量</th>
                                    <th class="text-end">淨利潤</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s in recent_sales %}
                                <tr>
                                    <td>{{ s.timestamp.strftime('%m-%d %H:%M') }}</td>
                                    <td><strong>{{ s.product.name }}</strong></td>
                                    <td class="text-center"><span class="badge bg-secondary rounded-pill">{{ s.quantity }}</span></td>
                                    <td class="text-end profit-positive">+ ${{ "%.2f"|format(s.profit) }}</td>
                                </tr>
                                {% else %}
                                <tr><td colspan="4" class="text-center text-muted py-4">這兩天暫無銷售紀錄</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="content-card h-100">
                    <h4 class="section-title"><i class="fas fa-history me-2"></i>每日總結存檔</h4>
                    <div class="list-group list-group-flush scroll-area mt-3">
                        {% for file in history_files %}
                        <a href="/view_report/{{ file }}" class="list-group-item list-group-item-action history-item d-flex justify-content-between align-items-center py-3">
                            <div class="text-truncate">
                                <i class="far fa-file-alt text-warning me-2"></i>
                                <small class="fw-bold text-dark">{{ file }}</small>
                            </div>
                            <i class="fas fa-chevron-right text-muted small"></i>
                        </a>
                        {% else %}
                        <div class="text-center py-5 text-muted">
                            <i class="fas fa-inbox fa-2x mb-3 text-secondary"></i>
                            <p>尚無歷史存檔<br><small>系統將於每日 0:00 自動生成</small></p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer-custom text-center">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-12">
                    <p class="mb-0">&copy; 2026 <strong>張家銘</strong>. All Rights Reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const chartData = {{ chart_data|tojson }};
        let dailyChart, monthlyChart, productPieChart;
        Chart.defaults.font.family = "'Segoe UI', Roboto, sans-serif";
        Chart.defaults.color = '#666';

        function generateColors(count) {
            const colors = ['#ffda6a', '#ff9f43', '#ff6b6b', '#48dbfb', '#1dd1a1', '#5f27cd', '#ff9ff3', '#54a0ff', '#00d2d3', '#2e86de'];
            let result = [];
            for (let i = 0; i < count; i++) { result.push(colors[i % colors.length]); }
            return result;
        }

        document.addEventListener("DOMContentLoaded", function() {
            initTrendCharts();
            initPieChart();
        });

        function initTrendCharts() {
            const ctxDaily = document.getElementById('dailyChart').getContext('2d');
            const ctxMonthly = document.getElementById('monthlyChart').getContext('2d');
            
            const commonConfig = {
                type: 'line',
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true }, x: { grid: { display: false } } } }
            };

            dailyChart = new Chart(ctxDaily, { ...commonConfig, data: { labels: chartData.daily.labels, datasets: [{ label: '利潤', data: chartData.daily.profit, borderColor: '#ffca28', backgroundColor: 'rgba(255, 206, 86, 0.2)', fill: true, tension: 0.4 }] } });
            monthlyChart = new Chart(ctxMonthly, { ...commonConfig, data: { labels: chartData.monthly.labels, datasets: [{ label: '利潤', data: chartData.monthly.profit, borderColor: '#4bc0c0', backgroundColor: 'rgba(75, 192, 192, 0.2)', fill: true, tension: 0.4 }] } });
        }

        function updateTrendCharts() {
            const metric = document.getElementById('trendMetricSelect').value;
            
            let dataKey, label, color, bgColor;
            
            if (metric === 'profit') {
                dataKey = 'profit'; label = '淨利潤 ($)'; color = '#ffca28'; bgColor = 'rgba(255, 206, 86, 0.2)';
            } else if (metric === 'revenue') {
                dataKey = 'revenue'; label = '總營收 ($)'; color = '#198754'; bgColor = 'rgba(25, 135, 84, 0.2)'; // 綠色
            } else {
                dataKey = 'qty'; label = '銷量 (件)'; color = '#ff6b6b'; bgColor = 'rgba(255, 107, 107, 0.2)';
            }
            
            // 更新每日圖
            dailyChart.data.datasets[0].data = chartData.daily[dataKey];
            dailyChart.data.datasets[0].label = label;
            dailyChart.data.datasets[0].borderColor = color;
            dailyChart.data.datasets[0].backgroundColor = bgColor;
            
            // 更新每月圖
            monthlyChart.data.datasets[0].data = chartData.monthly[dataKey];
            monthlyChart.data.datasets[0].label = label;
            // 每月圖顏色也可以跟著變，或者保持藍綠色，這裡我讓它跟著變，視覺更統一
            monthlyChart.data.datasets[0].borderColor = color === '#ffca28' ? '#4bc0c0' : color; 
            monthlyChart.data.datasets[0].backgroundColor = color === '#ffca28' ? 'rgba(75, 192, 192, 0.2)' : bgColor;

            dailyChart.update();
            monthlyChart.update();
        }

        function initPieChart() {
            const ctxPie = document.getElementById('productPieChart').getContext('2d');
            productPieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: chartData.product.labels,
                    datasets: [{ data: chartData.product.profit, backgroundColor: generateColors(chartData.product.labels.length), borderWidth: 1 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: function(context) { 
                        const metric = document.getElementById('pieMetricSelect').value;
                        let val = context.raw;
                        if (metric === 'profit' || metric === 'revenue') val = '$' + val;
                        else val = val + ' 件';
                        return context.label + ': ' + val;
                    }}}}
                }
            });
        }

        function updatePieChart() {
            const metric = document.getElementById('pieMetricSelect').value;
            productPieChart.data.datasets[0].data = chartData.product[metric];
            productPieChart.update();
        }
    </script>
</body>
</html>